name: Sync Migu JSON Hourly

on:
  schedule:
    - cron: '0 * * * *' # æ¯å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:

jobs:
  update-migu-json:
    runs-on: ubuntu-latest
    steps:
      # 1ï¸âƒ£ æ£€å‡º GitHub ä»“åº“
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          fetch-depth: 0

      # 2ï¸âƒ£ ä¸‹è½½ interface.txt
      - name: Download interface.txt
        run: |
          curl -sSL -o interface.txt "https://raw.githubusercontent.com/develop202/migu_video/refs/heads/main/interface.txt"
          if [ ! -s interface.txt ]; then
            echo "Failed to download interface.txt"
            exit 1
          fi
          echo "Downloaded interface.txt successfully"
          echo "First few lines:"
          head -3 interface.txt

      # 3ï¸âƒ£ è§£æ M3U å¹¶ç”Ÿæˆ migu.json
      - name: Convert M3U to JSON
        run: |
          python3 << 'EOF'
import re
import json

# è¯»å– M3U æ–‡ä»¶
with open('interface.txt', 'r', encoding='utf-8') as f:
    lines = f.readlines()

channels = {}
current_name = None

for line in lines:
    line = line.strip()
    
    # è·³è¿‡ M3U å¤´ä¿¡æ¯å’Œç©ºè¡Œ
    if line.startswith('#EXTM3U') or not line:
        continue
    
    # è§£æé¢‘é“ä¿¡æ¯è¡Œ
    if line.startswith('#EXTINF:'):
        # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æå– svg-name
        name_match = re.search(r'svg-name="([^"]+)"', line)
        if name_match:
            current_name = name_match.group(1)
        else:
            # å¦‚æœæ‰¾ä¸åˆ° svg-nameï¼Œå°è¯•ä»é¢‘é“åç§°éƒ¨åˆ†æå–
            name_match = re.search(r',([^,]+)$', line)
            if name_match:
                current_name = name_match.group(1).strip()
    
    # è§£æ URL è¡Œ
    elif line.startswith('http'):
        if current_name:
            # æ¸…ç† URLï¼ˆç§»é™¤å¯èƒ½çš„æ—¶é—´æˆ³å‚æ•°ï¼‰
            url = re.sub(r'(&?timestamp=\d+)', '', line)
            url = re.sub(r'(&?SecurityKey=\d+)', '', url)
            channels[current_name] = url
            current_name = None

print(f"æˆåŠŸè§£æ {len(channels)} ä¸ªé¢‘é“")

# ä¿å­˜ä¸º JSON æ–‡ä»¶
with open('migu.json', 'w', encoding='utf-8') as f:
    json.dump(channels, f, ensure_ascii=False, indent=2)

print("migu.json æ–‡ä»¶å·²ç”Ÿæˆ")
EOF

      # 4ï¸âƒ£ éªŒè¯ç”Ÿæˆçš„ JSON æ–‡ä»¶
      - name: Validate JSON
        run: |
          echo "ç”Ÿæˆçš„ JSON æ–‡ä»¶å‰å‡ ä¸ªé¢‘é“:"
          head -10 migu.json
          echo "æ€»é¢‘é“æ•°: $(jq 'length' migu.json)"
          echo "ç¤ºä¾‹é¢‘é“:"
          jq 'to_entries | .[0:2] | from_entries' migu.json

      # 5ï¸âƒ£ æäº¤å¹¶æ¨é€æ›´æ”¹
      - name: Commit and Push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add migu.json
          
          if git diff --cached --quiet; then
            echo "æ²¡æœ‰å˜åŒ–éœ€è¦æäº¤"
          else
            echo "æ£€æµ‹åˆ°å˜åŒ–ï¼Œæäº¤å¹¶æ¨é€"
            git status
            NOW=$(TZ=Asia/Shanghai date '+%Y-%m-%d %H:%M:%S')
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–° migu.json [$NOW]"
            git push origin main
            echo "æ›´æ”¹å·²æ¨é€"
          fi

      # 6ï¸âƒ£ æ¸…ç†ä¸´æ—¶æ–‡ä»¶
      - name: Clean up
        run: |
          rm -f interface.txt
          echo "ä¸´æ—¶æ–‡ä»¶å·²æ¸…ç†"
